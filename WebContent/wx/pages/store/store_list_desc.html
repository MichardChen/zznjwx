<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0,minimum-scale=1.0,user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="../../lib/mui/css/mui.min.css">
    <link rel="stylesheet" href="../../static/font/style.css">
    <link rel="stylesheet" href="../../static/css/common/reset.css">
     <link rel="stylesheet" href="http://cache.amap.com/lbs/static/main1119.css"/>
    <link rel="stylesheet" href="../../static/css/store/store_desc.css">
    <script type="text/javascript" src="http://webapi.amap.com/maps?v=1.4.6&key=373f652b48d2c24e5b9295fa1b1bbc54"></script>
 <!--   <script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script>-->
    <!--<script type="text/javascript" src="https://webapi.amap.com/demos/js/liteToolbar.js"></script>-->
    <title>茶店详情</title>
</head>

<body>
	<section class="page-container">
		<div class="mui-content">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<div class="store">
						<h3 class="store-name"></h3>
						<p class="store-address"><span class="mui-icon"></span><span class="address-desc"></span></p>
					</div>
					<div class="phone">
						<span class="icon-phone"></span>						
					</div>
				</li>
				<li class="mui-table-view-cell">
					<div id="slider" class="mui-slider" >
						<div class="mui-slider-group">							
						</div>
					</div>
				</li>
				<li class="mui-table-view-cell">
					<div class="title">门店信息</div>
					<div class="desc-content">
						<p class="bussiness-time"></p>
						<p class="store-desc"></p>
					</div>
					<div id="map"></div>
				</li>
				<li class="mui-table-view-cell">
					<!--<div class="more-box mui-clearfix"><a class="more mui-pull-right">更多评价<span class="icon-next"></span></a></div>-->
					<ul class="evaluate-content">
					</ul>
				</li>
			</ul>
		</div>
	</section>
	<script src="../../lib/mui/js/mui.min.js"></script>
   <!--  <script src="../../lib/jquery/jquery-3.3.1.min.js"></script> -->
   <script src="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
    <script src="../../static/js/common/common.js"></script>
     <script src="../../static/js/store/mui.previewimage.js"></script>
      <script src="../../static/js/store/mui.zoom.js"></script>
  <!--   <script src="../../static/js/store/store_list_desc.js"></script> -->
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script type="text/javascript">
    window.onload=function(){
    	//请求列表数据
    		//var storeId = document.location.href.substring(document.location.href.indexOf("?")+1);
    		if (sessionStorage.storeId){
				var storeId = sessionStorage.storeId;
	    		$.ajax({
	    			type:"get",
	    			url:REQUEST_URL+"wxmrest/queryTeaStoreDetail",
	    			async:true,
	    			data:{
	    				"id":storeId
	    			},
	    			dataType:"json",
	    			success:function(data){
	    				if(data.code == REQUEST_OK){
	    					console.log(data.data);
	    					var store = data.data.store;
	    					var evaluateList = data.data.evaluateList;
	    					$(".phone").attr("data-mobile",store.mobile);
	    					$('.store-name').html(store.name);
	    					$(".address-desc").html(store.address);
	    					createsliderDom(store.imgs);
	    					$('.bussiness-time').html("营业时间：周一到周日 "+store.businessFromTime+"--"+store.businessToTime);
	    					$('.store-desc').html(store.storeDesc);
	    					createEvaluateList(evaluateList);
	    					createMap(store);
	    				}else{
	    					mui.toast(data.message);
	    					setTimeout(function(){
	    						noLoginHandle();
	    					}, 2000);
	    				}
	    			}
	    		});
	    		
	    		$.ajax({
	    			url : REQUEST_URL + "wxmrest/getData",
	    			type : "get",
	    			dataType : "json",
	    			async : true,
	    			data : {},
	    			success : function(data) {
	    				if (data.code == REQUEST_OK) {
	    					var timestamp = data.data.timestamp;
	    					var appId = data.data.appId;
	    					var nonceStr = data.data.nonceStr;
	    					var signature = data.data.signature;
	    					//JSSDK配置参数 通过config接口注入权限验证配置
	    					wx.config({
	    						debug : false,
	    						appId : appId,
	    						timestamp : timestamp,
	    						nonceStr : nonceStr,
	    						signature : signature,
	    						jsApiList : [ 'checkJsApi', 'onMenuShareTimeline',
	    								'onMenuShareAppMessage', 'onMenuShareQQ',
	    								'onMenuShareWeibo', 'hideMenuItems',
	    								'showMenuItems', 'hideAllNonBaseMenuItem',
	    								'showAllNonBaseMenuItem', 'translateVoice',
	    								'startRecord', 'stopRecord', 'onRecordEnd',
	    								'playVoice', 'pauseVoice', 'stopVoice',
	    								'uploadVoice', 'downloadVoice', 'chooseImage',
	    								'previewImage', 'uploadImage', 'downloadImage',
	    								'getNetworkType', 'openLocation',
	    								'getLocation', 'hideOptionMenu',
	    								'showOptionMenu', 'closeWindow', 'scanQRCode',
	    								'chooseWXPay', 'openProductSpecificView',
	    								'addCard', 'chooseCard', 'openCard' ]
	    					});
	    				}
	    			},
	    			error : function(msg) {
	    				//console.log(msg);
	    			}
	    		})

    	}
    	
    	var createsliderDom = function(data){
    		var slider = $('.mui-slider-group');
    		data.forEach(function(n){
    			var img = '<a><img src="'+n+'" width=75 height=75 data-preview-src=""  data-preview-group="1"></a>';
    			slider.append(img);
    		})
    	}
    	
    	var computedStar = function(scroe){
    		var html="";
    		for(var i =1;i<=5;i++){
    			if(i<=scroe){
    				html+='<span class="icon-star"></span>';
    			}else{
    				html+='<span class="icon-star-c"></span>';
    			}
    		}
    		return html;
    	}
    	
    	var createEvaluateList = function(data){
    		var list = $('.evaluate-content');
    		data.forEach(function(n){
    			var li = $('<li/>');
    			var user = $('<div class="user"/>');
    			var userimg = '<a class="user-img"><img src='+n.icon+' width=50 height=50 ></a>';
    			var userName = '<div class="user-desc"><h3>'+n.userName+'</h3><p class="evaluate">评分 '+computedStar(n.point)+'<span class="mui-pull-right">'+n.createDate+'</span></p></div>';
    			user.html(userimg+userName);
    			var evaluate = $('<p class="valuate-text">'+n.comment+'</p>')
    			li.append(user,evaluate);
    			list.append(li);			
    		})		
    	}
    	
    	var createMap = function(data){
    		var latitude = data.latitude;
    		var longitude = data.longitude;
    		
    		var map = new AMap.Map("map", {
            resizeEnable: true,
            center: [longitude, latitude],//地图中心点
            zoom: 18 //地图显示的缩放级别,
    	    });
    	    
    	    //添加点标记，并使用自己的icon
    	    var marker = new AMap.Marker({
    	        map: map,
    			position: [longitude, latitude],
    	        icon: new AMap.Icon({            
    	            size: new AMap.Size(40, 83),  //图标大小
    	            image: "http://app.tongjichaye.com:88/common/location.png",
    	            imageOffset: new AMap.Pixel(0, 0)
    	        }),     
    			label: {
    				offset: new AMap.Pixel(-75, -40),//修改label相对于maker的位置
    				content: "<div class='goMap'><div class='store-address'><strong>"+$('.store-name').html()+"</strong><br>"+$(".address-desc").html()+"</div><button class='go-map'>去导航</button></div>"
    			}         
    	    });
    	    
    		marker.on('click',function(e){
    			$('.amap-marker-label').show()
    			mui('.amap-marker-label').on("tap",'.go-map',function(){
    				wx.openLocation({
    					latitude : latitude,
    					longitude : longitude,
    					name : $('.store-name').html(), //要写引号
    					address : $(".address-desc").html(), //要写引号
    					scale : 15,
    					infoUrl : "http://www.baidu.com" //要写引号
    				}); 
    			/*	mui.openWindow({
    					url:'http://uri.amap.com/navigation?to='+longitude+','+latitude+','+$(".address-desc").html()+'&via='+longitude+','+latitude+'&mode=car&src=nyx_super'
    				})*/
    			})	      
    		})
        
    		AMap.plugin(['AMap.ToolBar','AMap.Scale'],function(){
    			var toolBar = new AMap.ToolBar();
    			var scale = new AMap.Scale();
    			map.addControl(toolBar);
    			map.addControl(scale);
    		})
       
    	    
    	}
    	
    	mui(".mui-table-view-cell").on('tap','.phone',function(){
    		var mobile = $(this).attr("data-mobile");
    		mui.confirm(mobile,' ',["取消","呼叫"]);
    	})
    	
    	mui.previewImage();
    	
    }

    wx.ready(function() {});
    wx.error(function(res) {alert(res.errMsg);});
    </script>
</body>
</html>